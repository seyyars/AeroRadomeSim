name: Build LaTeX PDF

on:
  workflow_dispatch:
  push:
    paths:
      - 'report/**'
      - '.github/workflows/latex.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install numpy matplotlib

      - name: Generate figures
        run: |
          python - << 'EOF'
          from pathlib import Path
          import numpy as np
          import matplotlib.pyplot as plt

          out = Path("report") / "figures"
          out.mkdir(parents=True, exist_ok=True)

          # --- 1) Wall temperature vs Mach ---
          gamma = 1.4
          T_inf = 288.0
          r = 0.9

          M = np.linspace(0.0, 3.0, 200)
          T0 = T_inf * (1.0 + (gamma - 1.0)/2.0 * M**2)
          Tw = T_inf + r * (T0 - T_inf)

          plt.figure()
          plt.plot(M, Tw)
          plt.xlabel("Mach number")
          plt.ylabel(r"Wall temperature $T_w$ [K]")
          plt.title("Wall temperature vs Mach number")
          plt.grid(True)
          plt.tight_layout()
          plt.savefig(out / "temperature_vs_mach.pdf")
          plt.close()

          # --- 2) RF transmission loss vs Mach ---
          eps0 = 4.0
          tan_delta0 = 0.002
          T_ref = 300.0
          a_eps = 2e-3
          a_tan = 1e-5

          eps_real = eps0 + a_eps * (Tw - T_ref)
          tan_delta = tan_delta0 + a_tan * (Tw - T_ref)
          eps_imag = eps_real * tan_delta
          eps_r = eps_real - 1j*eps_imag

          c0 = 299_792_458.0
          f = 10e9
          k0 = 2.0*np.pi*f/c0
          d = 0.01

          n1 = 1.0
          n3 = 1.0
          n2 = np.sqrt(eps_r)
          phi = k0*n2*d

          r12 = (n1 - n2) / (n1 + n2)
          r23 = (n2 - n3) / (n2 + n3)
          t12 = 2.0*n1 / (n1 + n2)
          t23 = 2.0*n2 / (n2 + n3)

          T_amp = t12 * t23 * np.exp(1j*phi) / (1.0 + r12*r23*np.exp(2j*phi))
          T_power = np.abs(T_amp)**2
          loss_dB = -10.0*np.log10(T_power)

          plt.figure()
          plt.plot(M, loss_dB)
          plt.xlabel("Mach number")
          plt.ylabel("Transmission loss [dB]")
          plt.title("Radome RF transmission loss vs Mach number")
          plt.grid(True)
          plt.tight_layout()
          plt.savefig(out / "transmission_loss_vs_mach.pdf")
          plt.close()
          EOF

      - name: Compile LaTeX
        uses: xu-cheng/latex-action@v3
        with:
          root_file: report/main.tex

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: aeroradomesim-report
          path: report/main.pdf
